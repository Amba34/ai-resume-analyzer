name: CD - Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REGISTRY: gcr.io
  BACKEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/ai-resume-backend:${{ github.sha }}
  FRONTEND_IMAGE: gcr.io/${{ secrets.GCP_PROJECT_ID }}/ai-resume-frontend:${{ github.sha }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build Images
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Build and Push Backend
        run: |
          echo "ğŸ”¨ Building backend: ${{ env.BACKEND_IMAGE }}"
          docker build -t ${{ env.BACKEND_IMAGE }} ./Backend
          docker push ${{ env.BACKEND_IMAGE }}
          echo "âœ… Backend pushed: ${{ env.BACKEND_IMAGE }}"

      - name: Build and Push Frontend
        run: |
          echo "ğŸ”¨ Building frontend: ${{ env.FRONTEND_IMAGE }}"
          docker build -t ${{ env.FRONTEND_IMAGE }} ./Frontend
          docker push ${{ env.FRONTEND_IMAGE }}
          echo "âœ… Frontend pushed: ${{ env.FRONTEND_IMAGE }}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Backend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: build
    
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Backend
        id: deploy
        run: |
          echo "ğŸš€ Deploying backend: ${{ env.BACKEND_IMAGE }}"
          
          gcloud run deploy ai-resume-backend \
            --image="${{ env.BACKEND_IMAGE }}" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --port=3000 \
            --timeout=300 \
            --startup-cpu-boost \
            --cpu-throttling \
            --execution-environment=gen2 \
            --set-env-vars="NODE_ENV=production,PORT=3000,MONGODB_URI=${{ secrets.MONGODB_URI }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
            --quiet
          
          URL=$(gcloud run services describe ai-resume-backend --region=${{ env.REGION }} --format="value(status.url)")
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed: $URL"
          
          # Test health endpoint
          echo "ğŸ” Testing health endpoint..."
          sleep 15
          curl -f "$URL/health" || echo "âš ï¸ Health check failed, but continuing..."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Frontend
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build, deploy-backend]

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy Frontend
        run: |
          BACKEND_URL="${{ needs.deploy-backend.outputs.url }}"
          echo "ğŸš€ Deploying frontend: ${{ env.FRONTEND_IMAGE }}"
          echo "ğŸ”— Backend URL: $BACKEND_URL"
          
          gcloud run deploy ai-resume-frontend \
            --image="${{ env.FRONTEND_IMAGE }}" \
            --region="${{ env.REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --port=80 \
            --timeout=60 \
            --execution-environment=gen2 \
            --set-env-vars="VITE_API_URL=$BACKEND_URL" \
            --quiet
          
          FRONTEND_URL=$(gcloud run services describe ai-resume-frontend --region=${{ env.REGION }} --format="value(status.url)")
          echo "âœ… Frontend deployed: $FRONTEND_URL"

      - name: Show Results
        run: |
          echo "ğŸ‰ Deployment Complete!"
          echo "âœ… Backend:  ${{ needs.deploy-backend.outputs.url }}"
          FRONTEND_URL=$(gcloud run services describe ai-resume-frontend --region=${{ env.REGION }} --format="value(status.url)")
          echo "âœ… Frontend: $FRONTEND_URL"